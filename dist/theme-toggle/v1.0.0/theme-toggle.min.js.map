{"version":3,"file":"theme-toggle.min.js","sources":["../../../packages/theme-toggle/src/theme-toggle.js"],"sourcesContent":["// Theme Manager - Declarative theme toggle with state management\n// Core script handles state/logic only - developers control styling via CSS\n\n(() => {\n  // ─── Config ────────────────────────────────────────────────────────────────\n  const ATTR_THEME = 'data-theme';\n  const ATTR_TOGGLE = 'data-theme-toggle';\n  const ATTR_VALUE = 'data-theme-value';\n  const STORAGE_KEY = 'theme';\n  const DEFAULT_THEMES = ['light', 'dark'];\n\n  // ─── Theme Manager ─────────────────────────────────────────────────────────\n  const ThemeManager = {\n    // Available themes - extend this array for multi-theme support\n    themes: DEFAULT_THEMES.slice(),\n\n    // Current effective theme (never \"system\")\n    current: null,\n\n    // User's theme choice (can be \"system\", \"light\", \"dark\", etc.)\n    theme: null,\n\n    // Initialization state\n    initialized: false,\n\n    // Internal storage for cleanup\n    _toggles: [],\n    _toggleListeners: new WeakMap(),\n    _mediaQuery: null,\n    _mediaQueryListener: null,\n\n    // Returns the effective theme (resolves 'system' to actual light/dark)\n    getEffectiveTheme(theme) {\n      if (theme === 'system') {\n        return window.matchMedia('(prefers-color-scheme: dark)').matches\n          ? 'dark'\n          : 'light';\n      }\n      return theme;\n    },\n\n    // Sets the active theme with validation\n    setTheme(newTheme, options = {}) {\n      const { force = false } = options;\n\n      // Calculate effective theme\n      const isSystemMode = newTheme === 'system';\n      const newEffective = isSystemMode\n        ? this.getEffectiveTheme('system')\n        : newTheme;\n\n      // Validate effective theme exists (skip validation for system mode)\n      if (!isSystemMode && this.themes.indexOf(newTheme) === -1) {\n        console.warn(\n          `[ThemeManager] Theme \"${newTheme}\" not in themes array:`,\n          this.themes\n        );\n        return this;\n      }\n\n      // Skip if no change (unless forced)\n      if (!force && newEffective === this.current && newTheme === this.theme) {\n        return this;\n      }\n\n      const previousEffective = this.current;\n      const previousTheme = this.theme;\n\n      this.current = newEffective;\n      this.theme = newTheme;\n\n      // Update class on <html> (remove old, add new)\n      if (previousEffective) {\n        document.documentElement.classList.remove(previousEffective);\n      }\n      document.documentElement.classList.add(newEffective);\n\n      // Set data-theme attribute to user's choice (can be \"system\")\n      document.documentElement.setAttribute(ATTR_THEME, newTheme);\n\n      // Save user's choice to localStorage\n      try {\n        localStorage.setItem(STORAGE_KEY, newTheme);\n      } catch (e) {\n        console.warn('[ThemeManager] localStorage unavailable');\n      }\n\n      // Dispatch event if there was any change\n      const effectiveChanged = previousEffective !== newEffective;\n      if (effectiveChanged || previousTheme !== newTheme || force) {\n        window.dispatchEvent(\n          new CustomEvent('themechange', {\n            detail: {\n              theme: newEffective,\n              previous: previousEffective,\n              userTheme: newTheme,\n              previousUserTheme: previousTheme,\n              effectiveChanged,\n            },\n          })\n        );\n      }\n\n      return this;\n    },\n\n    // Returns the current effective theme\n    getTheme() {\n      return this.current;\n    },\n\n    // Returns the user's theme choice (can be \"system\")\n    getUserTheme() {\n      return this.theme;\n    },\n\n    // Returns the source for backwards compatibility\n    getSource() {\n      return this.theme === 'system' ? 'system' : 'user';\n    },\n\n    // Cycles to the next theme (skips \"system\")\n    toggleTheme() {\n      // Filter out \"system\" from cycle\n      const cyclableThemes = this.themes.filter((t) => t !== 'system');\n\n      const currentIndex = cyclableThemes.indexOf(this.current);\n      const nextIndex =\n        currentIndex === -1 ? 0 : (currentIndex + 1) % cyclableThemes.length;\n\n      return this.setTheme(cyclableThemes[nextIndex]);\n    },\n\n    // Sets up toggle and value button click listeners\n    _setupToggles() {\n      // Setup data-theme-toggle (cycle)\n      document.querySelectorAll(`[${ATTR_TOGGLE}]`).forEach((btn) => {\n        const listener = () => this.toggleTheme();\n        btn.addEventListener('click', listener);\n        this._toggles.push(btn);\n        this._toggleListeners.set(btn, listener);\n      });\n\n      // Setup data-theme-value (explicit)\n      document.querySelectorAll(`[${ATTR_VALUE}]`).forEach((btn) => {\n        const theme = btn.getAttribute(ATTR_VALUE);\n        const listener = () => this.setTheme(theme);\n        btn.addEventListener('click', listener);\n        this._toggles.push(btn);\n        this._toggleListeners.set(btn, listener);\n      });\n    },\n\n    // Removes toggle button click listeners\n    _teardownToggles() {\n      this._toggles.forEach((toggle) => {\n        const listener = this._toggleListeners.get(toggle);\n        if (listener) {\n          toggle.removeEventListener('click', listener);\n          this._toggleListeners.delete(toggle);\n        }\n      });\n      this._toggles = [];\n    },\n\n    // Initializes ThemeManager and attaches event listeners\n    init() {\n      if (this.initialized) {\n        console.warn('[ThemeManager] Already initialized. Call destroy() first.');\n        return this;\n      }\n\n      try {\n        // Read user's theme choice from localStorage\n        let stored = null;\n        try {\n          stored = localStorage.getItem(STORAGE_KEY);\n        } catch (e) {\n          // localStorage unavailable\n        }\n\n        // Default to \"system\" if no stored value\n        const theme = stored || 'system';\n\n        // Validate stored theme (allow \"system\" or any theme in array)\n        if (theme !== 'system' && this.themes.indexOf(theme) === -1) {\n          // Invalid stored theme - fallback to system\n          this.theme = 'system';\n        } else {\n          this.theme = theme;\n        }\n\n        this.current = this.getEffectiveTheme(this.theme);\n\n        // Ensure DOM matches (in case head-code didn't run)\n        this.setTheme(this.theme, { force: true });\n\n        // Setup toggle button click listeners\n        this._setupToggles();\n\n        // Setup system preference sync\n        this._setupSystemSync();\n\n        this.initialized = true;\n      } catch (e) {\n        console.error('[ThemeManager] Initialization failed:', e);\n      }\n\n      return this;\n    },\n\n    // Sets up system preference change listener\n    _setupSystemSync() {\n      this._mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');\n\n      this._mediaQueryListener = (e) => {\n        // Only react if user chose system mode\n        if (this.theme === 'system') {\n          const newEffective = e.matches ? 'dark' : 'light';\n          const previousEffective = this.current;\n\n          this.current = newEffective;\n\n          // Update class on <html>\n          document.documentElement.classList.remove(previousEffective);\n          document.documentElement.classList.add(newEffective);\n\n          // Dispatch event for developer animations\n          window.dispatchEvent(\n            new CustomEvent('themechange', {\n              detail: {\n                theme: newEffective,\n                previous: previousEffective,\n                userTheme: 'system',\n                previousUserTheme: 'system',\n                effectiveChanged: true,\n              },\n            })\n          );\n        }\n      };\n\n      this._mediaQuery.addEventListener('change', this._mediaQueryListener);\n    },\n\n    // Removes system preference change listener\n    _teardownSystemSync() {\n      if (this._mediaQuery && this._mediaQueryListener) {\n        this._mediaQuery.removeEventListener('change', this._mediaQueryListener);\n        this._mediaQuery = null;\n        this._mediaQueryListener = null;\n      }\n    },\n\n    // Re-scan DOM for toggle buttons (useful for SPAs)\n    refresh() {\n      if (!this.initialized) {\n        console.warn('[ThemeManager] Not initialized. Call init() first.');\n        return this;\n      }\n\n      // Remove existing listeners\n      this._teardownToggles();\n\n      // Re-setup toggles\n      this._setupToggles();\n\n      return this;\n    },\n\n    // Cleans up event listeners and resets state\n    destroy() {\n      if (!this.initialized) {\n        return this;\n      }\n\n      // Remove toggle listeners\n      this._teardownToggles();\n\n      // Remove system sync listener\n      this._teardownSystemSync();\n\n      // Reset state\n      this.current = null;\n      this.theme = null;\n      this.initialized = false;\n\n      return this;\n    },\n  };\n\n  // Auto-initialize on DOMContentLoaded\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => {\n      ThemeManager.init();\n    });\n  } else {\n    ThemeManager.init();\n  }\n\n  // Expose to window\n  if (typeof window !== 'undefined') {\n    window.ThemeManager = ThemeManager;\n  }\n})();\n"],"names":["ATTR_VALUE","STORAGE_KEY","ThemeManager","themes","slice","current","theme","initialized","_toggles","_toggleListeners","WeakMap","_mediaQuery","_mediaQueryListener","getEffectiveTheme","window","matchMedia","matches","setTheme","newTheme","options","force","isSystemMode","newEffective","this","indexOf","console","warn","previousEffective","previousTheme","document","documentElement","classList","remove","add","setAttribute","localStorage","setItem","e","effectiveChanged","dispatchEvent","CustomEvent","detail","previous","userTheme","previousUserTheme","getTheme","getUserTheme","getSource","toggleTheme","cyclableThemes","filter","t","currentIndex","nextIndex","length","_setupToggles","querySelectorAll","forEach","btn","listener","addEventListener","push","set","getAttribute","_teardownToggles","toggle","get","removeEventListener","delete","init","stored","getItem","_setupSystemSync","error","_teardownSystemSync","refresh","destroy","readyState"],"mappings":"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"}